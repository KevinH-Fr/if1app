
<% if user_signed_in? %>

<br/>

      <h1 class="fa-solid fa-person-military-pointing fa-2xl fw-bold fs-1"> - Licences </h1>   
      <br/> <br/> <hr/> <br/>


  <% if (@eventId).present? %>
  <% eventId = @eventId%>
  <%= eventId%>

 <%= link_to "Créer licences",  downgrade1_licence_path(eventId), class:"btn btn-secondary", :onclick => "return confirm('Créer les licences des titulaires ?')" %> 
<% end %>




 <%# btn choix saison %>
      Choix saison |
        <% @saisons.each do |saison| %>
              <%= link_to "#{saison.nom}", 
              licences_path(saisonId: saison.id), class:"btn btn-secondary", :method => :post %> 
        <% end %>

          <% if (@saisonId).present? %>
            <% @saisonId %>
            <hr/> 

            <%# btn choix division %>
            Choix division |
            <% @divisions.each do |division| %>
              <%= link_to "#{division.nom}", 
                  licences_path(saisonId: @saisonId, divisionId: division.id), 
                  class:"btn btn-dark", :method => :post %> 
            <% end %>

              <% if (@divisionId).present? %>
                <% @divisionId %>
                <hr/> 

             <%# btn choix event %>
                Choix event |
                <% @eventsFiltres.order(:numero).each do |event| %>
                  <% if @saisonId = event.saison_id %>
                    <% if @divisionId = event.division_id %>
                      <% divGp = Division.find(event.division_id).numero %>
                      <% saisonEvent = Saison.find(event.saison_id).nom %>
                      <% numGp = Event.find(event.id).numero %>
                      <% nomPays = Circuit.find(event.circuit_id).pays %>
                      <%= link_to "GP #{event.numero}"" - #{nomPays}", 
                          licences_path(saisonId: @saisonId, divisionId: @divisionId, eventId: event.id, numGp: numGp), 
                          class:"btn btn-primary", :method => :post %> 

                        <%#= link_to "Créer licences",  licences_downgrade1_path(eventId: 3), class:"btn btn-secondary", :onclick => "return confirm('Créer les licences des titulaires ?')" %> 

                    <% end %>
                    
                  <% end %>
                <% end %>

                

              <% end %>
          <% end %>
      <hr/> 

  <% if (@eventId).present? %>
  <% eventId = @eventId%>

     <table>  
          <%# @divisions.each do |division| %>
            <tr>
               <td> <%#= division.nom  %></td>
                <td> <%#= link_to "Creer licence", toggle_licence_licence_path(division), class:"btn btn-secondary", 
                      :onclick => "return confirm('Créer la licence ?')" %> </td>
                  
            </tr>
          <%# end %>
     </table>
   <br>

   <%# table des situation licences pilotes titulaires %>
   <h5> Synthese des licences </h5> 

    <table class="table table-striped table-bordered table-hover">
      <thead class="table-dark">
        <tr>
          <th>Titulaires</th>
          <th>Val départ</th>
          <th>Pts perdus</th>
          <th>Pts gagnés</th>
          <th>Solde</th>
        </tr>
      </thead>

        <tbody>
        <tr>
          <% @licencesFiltres.each_with_index do | licence, i| %>
          
            <td>
              <% if licence.pilote_id.present? %>
                <%= Pilote.find(licence.pilote_id).nom  %>
              <% end %>  
            </td>
            <td style="text-align: center;">
              <%= @licencesValDepart %>
             </td>
            <td style="text-align: center;">
                <%= licence.total_penalite %>
            </td>
            <td style="text-align: center;">
                <%= licence.total_recupere %>
            </td>
             <td style="text-align: center;">
              <strong>
                <%= @licencesValDepart.to_i - licence.total_penalite.to_i + licence.total_recupere.to_i %>
              </strong>
            </td>


        
        </tr>
        <% end %>
      </tbody>
    </table>


    <br><hr> 
  <% end %>

<%# table opérations sur licences %>

<h5> Opérations sur licences </h5> 

  <table class="table table-striped table-bordered table-hover">
    <thead class="table-dark">
      <tr>
        <th>Pilote</th>
        <th>Event</th>
        <th>Pénalité</th>
        <th>Récupéré</th>
        <th colspan="3">Actions</th>
     
      </tr>
    </thead>

    <tbody>
      <% @licences.each do |licence| %>
            <tr>
            
             <td> 
                <% piloteLie = licence.pilote_id %>
                  <% if piloteLie.present? %>
                    <%= Pilote.find(piloteLie).nom %>
                  <% end %>
              </td>

              <td style="text-align: center;">  <%= licence.event_id %> </td>
              <td style="text-align: center;">  <%= licence.penalite %> </td>    
              <td style="text-align: center;">  <%= licence.recupere %> </td>    

                <td width="5%">
                    <%= link_to '', licence, class:"fa-solid fa-eye btn btn-primary" %> 
                </td>
                  <% if current_user.admin? %>
                    <td width="5%">
                      <%= button_to '', licence, class:"fa-solid fa-trash-can btn btn-danger", method: :delete, :onclick => "return confirm('Sûr ?')" %>
                    </td> 
                    <td width="5%">
                        <%= link_to "", edit_licence_path(licence), class:"fa-regular fa-pen-to-square btn btn-secondary" %> 
                    </td> 
                  <% end %>

            </tr>
      <% end %>
    </tbody>
  </table>

  <br>

  <% if current_user.admin? %>
   <%= link_to "Nouvelle licence", new_licence_path, class:"btn btn-primary" %>
    <br><br>



  <% end %>

<% else %>

  <h3> Vous n'avez pas les droits...</h3>
  
<% end %>

